let CHART_TIMER,SELECTED_SYMBOL="",SELECTED_NAME="",SELECTED_SYMBOL_PRICE=0,SELECTED_EXCHANGE=getURLParameter("exchange")||"USD",isMobile=window.matchMedia("(max-width: 600px)").matches;$(function(){$(window).on("resize",()=>{isMobile=window.matchMedia("(max-width: 600px)").matches});const e=e=>{let a=0;const t=e.map(e=>{const t="rgba(255,82,82, 0.8)",l="rgba(0, 150, 136, 0.8)",r=a<=e.close?l:t;return a=e.close,{time:e.time,value:1*e.volume,color:r}});return t};var a=300;const t=$(".side--panel").width(),l=$("main").width()-t-20,r=document.getElementById("tvchart"),o=LightweightCharts.createChart(r,{width:l,height:a,crosshair:{mode:LightweightCharts.CrosshairMode.Normal}});var s=o.addCandlestickSeries(),d=o.addHistogramSeries({color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:"",scaleMargins:{top:.8,bottom:0}});const n=[{text:"1분",value:"1m"},{text:"3분",value:"3m"},{text:"3분",value:"3m"},{text:"5분",value:"5m"},{text:"10분",value:"10m"},{text:"15분",value:"15m"},{text:"1시간",value:"1h"},{text:"12시간",value:"12h"},{text:"1일",value:"1d"},{text:"1주",value:"1w"}];n.map(e=>{$("#period").dropdown("add",e)}),$("#period").dropdown("select","1d"),$("#period").on("change",(e,a)=>{let t;t=a.replaceAll("주","w"),t=a.replaceAll("일","d"),t=a.replaceAll("시간","h"),t=a.replaceAll("분","m"),clearTimeout(CHART_TIMER),API.getChartData(SELECTED_SYMBOL,t,e=>{$(".details").removeClass("loading"),e.success?m(e.payload):alert(e.error.message)}),CHART_TIMER=setTimeout(()=>{API.getChartData(SELECTED_SYMBOL,t,e=>{$(".details").removeClass("loading"),e.success?i(e.payload):alert(e.error.message)})},1e4),API.getChartData(SELECTED_SYMBOL,t,e=>{m(e.payload,t)})});$("#period").dropdown("selected");const m=async a=>{function t(e,a,t,r){var s=l(e,a),d=o.addLineSeries({color:t||"rgba(4, 111, 232, 1)",lineWidth:r||1});d.setData(s)}function l(e,a){for(var t=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].close;return a/e.length},l=[],r=a-1,o=e.length;r<o;r++){var s=t(e.slice(r-a+1,r));l.push({time:e[r].time,value:s})}return l}const r=a.split("\n").slice(1).map((e,a)=>{const[t,l,r,o,s,d,n]=e.split("\t");return{time:new Date(t).getTime()/1e3,open:1*r,high:1*o,low:1*s,close:1*d,volume:1*n}});s.setData(r),d.setData(e(r)),t(r,10,"#F00"),t(r,30,"#0F0"),t(r,90,"#00F")},i=async e=>{e.split("\n").slice(1).map((e,a)=>{const[t,l,r,o,d,n,m]=e.split("\t");s.update({time:new Date(t).getTime()/1e3,open:1*r,high:1*o,low:1*d,close:1*n,volume:1*m})})};$.fn.dataTable.ext.errMode="none",$.extend($.fn.dataTable.defaults,{responsive:!0,lengthChange:!1,select:!0,info:!1,paging:!1,searching:!1,ordering:!0});$("#buyGrid").DataTable({processing:!1,serverSide:!0,paging:!0,scrollY:308,deferRender:!0,scroller:!0,ajax:{url:`${API.BASE_URL}/getOrderList/?symbol=${SELECTED_SYMBOL}&exchange=${SELECTED_EXCHANGE}&trading_type=buy`,type:"POST",dataSrc:"payload"},columns:[{data:(e,a,t,l)=>{const r=new $.fn.dataTable.Api("#buyGrid"),o=r.page.info();return o.length-l.row+1}},{data:()=>"삽니다"},{data:"time_order",render:e=>{const a=new Date(1e3*e);return a.getFullYear()+"."+String(a.getMonth()+1).padStart(2,"0")+"."+String(a.getDate()).padStart(2,"0")}},{data:"price",render:e=>`$${e}`},{data:"volume",render:e=>`${e}`},{data:"amount"},{data:"status",render:(e,a,t)=>{switch(e){case"close":return"판매완료";case"buy":return"구매완료";case"trading":return"거래중";case"open":return"대기"}}},{data:e=>{const a=e.price,t=e.volume,l=e.orderid;return'<button type="button" class="btn btn--blue btn--rounded" data-toggle="modal" data-volume="'+t+'" data-price="'+a+'" data-orderid="'+l+'" data-target="#modal-sell" style="width: 70px; height: 25px; line-height: 25px; font-size: 13px">판매</button>'}}],columnDefs:[{searchable:!1,orderable:!1,targets:0},{targets:"_all",className:"dt-head-center"},{targets:1,className:"dt-body-center",type:"title-string",orderable:!1},{targets:2,className:"dt-body-center",type:"any-number",orderable:!0},{targets:"price",className:"dt-body-right",type:"any-number",orderable:!0},{targets:4,className:"dt-body-center",type:"any-number"},{targets:5,className:"dt-body-center"},{targets:"status",className:"dt-body-center"},{targets:-1,className:"dt-body-center",orderable:!1}]}),$("#sellGrid").DataTable({processing:!1,serverSide:!0,paging:!0,scrollY:308,deferRender:!0,scroller:!0,ajax:{url:`${API.BASE_URL}/getOrderList/?symbol=${SELECTED_SYMBOL}&exchange=${SELECTED_EXCHANGE}&trading_type=sell`,type:"POST",dataSrc:"payload"},columns:[{data:(e,a,t,l)=>{const r=new $.fn.dataTable.Api("#sellGrid"),o=r.page.info();if(l)return o.length-l.row+1}},{data:()=>"삽니다"},{data:"time_order",render:e=>{const a=new Date(1e3*e);return a.getFullYear()+"."+String(a.getMonth()+1).padStart(2,"0")+"."+String(a.getDate()).padStart(2,"0")}},{data:"price",render:DataTable.render.number(null,null,2,"$")},{data:"volume",render:e=>`${e}`},{data:"amount"},{data:"status",render:(e,a,t)=>{switch(e){case"close":return"판매완료";case"buy":return"구매완료";case"trading":return"거래중";case"open":return"대기"}}},{data:e=>{const a=e.price,t=e.volume,l=e.orderid;return'<button type="button" class="btn btn--red btn--rounded" data-toggle="modal" data-symbol="'+SELECTED_SYMBOL+'" data-price="'+a+'" data-volume="'+t+'" data-orderid="'+l+'" data-target="#modal-buy" style="width: 70px; height: 25px; line-height: 25px; font-size: 13px">구매</button>'}}],columnDefs:[{searchable:!1,orderable:!1,targets:0},{targets:"_all",className:"dt-head-center"},{targets:1,className:"dt-body-center",type:"title-string",orderable:!1},{targets:2,className:"dt-body-center",type:"any-number",orderable:!0},{targets:"price",className:"dt-body-right",type:"any-number",orderable:!0},{targets:4,className:"dt-body-center",type:"any-number"},{targets:5,className:"dt-body-center"},{targets:"status",className:"dt-body-center"},{targets:-1,className:"dt-body-center",orderable:!1}],order:[[1,"asc"]]})}),$(function(){$("#modal-sell").submit(e=>(e.preventDefault(),API.sell($("#modal-sell").serializeObject(),e=>{e.success?($("#modal-sell").myModal("hide"),$("#modal-sell-success .tea--name").text(SELECTED_NAME),$("#modal-sell-success .volume").text($("#modal-sell [name=volume]").val().format()),$("#modal-sell-success").myModal("show")):alert(e.error.message)}),!1)),$("#modal-buy [name=price], #modal-buy [name=volume]").on("input",e=>{const a=parseFloat($("#modal-buy [name=price]").val()),t=parseFloat($("#modal-buy [name=volume]").val());$("#modal-buy [name=total]").val("$ "+(a*t).toFixed(2).format())}),$("#modal-sell [name=price], #modal-sell [name=volume]").on("input",e=>{const a=parseFloat($("#modal-sell [name=price]").val()),t=parseFloat($("#modal-sell [name=volume]").val());$("#modal-sell [name=total]").val("$ "+(a*t).toFixed(2).format())}),$("#modal-buy").submit(e=>(e.preventDefault(),API.buyDirect($("#modal-buy").serializeObject(),e=>{if(e.success){$("#modal-buy").myModal("hide");const e=parseFloat($("#modal-buy [name=price]").val()),a=parseFloat($("#modal-buy [name=volume]").val());$("#modal-buy-success .tea--name").text(SELECTED_NAME),$("#modal-buy-success .volume").text(a.format()),$("#modal-buy-success .total").text((e*a).format()),$("#modal-buy-success").myModal("show")}else alert(e.error.message)}),!1)),$("#modal-buy2").submit(e=>(e.preventDefault(),API.buy($("#modal-buy2").serializeObject(),e=>{if(e.success){$("#modal-buy2").myModal("hide");const e=parseFloat($("#modal-buy2 [name=price]").val()),a=parseFloat($("#modal-buy2 [name=volume]").val());$("#modal-buy-success .tea--name").text(SELECTED_NAME),$("#modal-buy-success .volume").text(a.format()),$("#modal-buy-success .total").text((e*a).format()),$("#modal-buy-success").myModal("show")}else alert(e.error.message)}),!1)),$("#modal-buy").myModal("beforeOpen",(e,a)=>{const t=a.data("orderid"),l=a.data("symbol"),r=a.data("price"),o=a.data("volume"),s=SELECTED_NAME,d=$("#modal-buy");d.find(".tea--available").text("$ "+(r*o).toFixed(2)),d.find("[name=orderid]").val(t),d.find("[name=symbol]").val(l),d.find("[name=price]").val(r),d.find("[name=volume]").val(o),d.find("[name=total]").val("$ "+(r*o).toFixed(2)),d.find(".tea--name").text(s)}),$("#modal-sell").submit(e=>(e.preventDefault(),API.sellDirect($("#modal-sell").serializeObject(),e=>{e.success?($("#modal-sell").myModal("hide"),$("#alert-sell").myModal("show")):alert(e.error.message)}),!1)),$("#modal-sell2").submit(e=>(e.preventDefault(),API.sell($("#modal-sell2").serializeObject(),e=>{e.success?($("#modal-sell2").myModal("hide"),$("#alert-sell").myModal("show")):alert(e.error.message)}),!1)),$("#modal-sell").myModal("beforeOpen",(e,a)=>{const t=a.data("orderid"),l=a.data("symbol"),r=a.data("price"),o=a.data("volume"),s=SELECTED_NAME,d=$("#modal-sell");d.find(".tea--available").text("$ "+(r*o).toFixed(2)),d.find("[name=orderid]").val(t),d.find("[name=symbol]").val(l),d.find("[name=price]").val(r),d.find("[name=volume]").val(o),d.find("[name=total]").val("$ "+(r*o).toFixed(2)),d.find(".tea--name").text(s)}),$("#modal-buy2").myModal("beforeOpen",e=>{const a=$("#modal-buy2");a.find(".tea--available").text("$ 0"),a.find("[name=symbol]").val(SELECTED_SYMBOL),a.find("[name=price]").val(SELECTED_SYMBOL_PRICE),a.find("[name=volume]").val(""),a.find("[name=total]").val("$ 0"),a.find(".tea--name").text(SELECTED_NAME)}),$("#modal-sell2").myModal("beforeOpen",e=>{const a=$("#modal-sell2");a.find(".tea--available").text("$ 0"),a.find("[name=symbol]").val(SELECTED_SYMBOL),a.find("[name=price]").val(SELECTED_SYMBOL_PRICE),a.find("[name=volume]").val(""),a.find("[name=total]").val("$ 0"),a.find(".tea--name").text(SELECTED_NAME)})});