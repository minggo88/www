<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ë¡œê·¸ì¸ | ì–´ì„±ì´ˆ í•œì˜ì›</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <div style="max-width: 400px; width: 100%; padding: 20px;">
        <!-- ë¡œê·¸ì¸ ì¹´ë“œ -->
        <div class="card" style="box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="text-center" style="margin-bottom: 30px;">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¥</div>
                <h2 style="color: #1e293b; margin-bottom: 5px;">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                <p style="color: #64748b; font-size: 14px;">ì–´ì„±ì´ˆ í•œì˜ì› ë¹„ëŒ€ë©´ ì§„ë£Œ ì‹œìŠ¤í…œ</p>
            </div>

            <form id="loginForm">
                <!-- ì•„ì´ë”” ì…ë ¥ -->
                <div class="form-group">
                    <label for="username" class="form-label required">ì•„ì´ë””</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        class="form-control"
                        placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autofocus
                    >
                </div>

                <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
                <div class="form-group">
                    <label for="password" class="form-label required">ë¹„ë°€ë²ˆí˜¸</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-control"
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    >
                </div>

                <!-- ë¡œê·¸ì¸ ìœ ì§€ -->
                <div class="form-check" style="margin-bottom: 20px;">
                    <input type="checkbox" id="remember" class="form-check-input">
                    <label for="remember" class="form-check-label">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</label>
                </div>

                <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <button type="submit" class="btn btn-primary btn-block btn-lg">
                    ë¡œê·¸ì¸
                </button>
            </form>

            <!-- ì¶”ê°€ ë§í¬ -->
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <a href="../index.html" style="color: #64748b; font-size: 14px; text-decoration: none;">
                    â† ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>
        </div>

        <!-- ê¸°ë³¸ ê³„ì • ì•ˆë‚´ (ê°œë°œìš© - ë‚˜ì¤‘ì— ì‚­ì œ) -->
        <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center;">
            <p style="margin: 0; font-size: 12px; color: #64748b;">
                <strong>ê°œë°œ í…ŒìŠ¤íŠ¸ìš© ê¸°ë³¸ ê³„ì •</strong><br>
                ì•„ì´ë””: admin / ë¹„ë°€ë²ˆí˜¸: admin1234!
            </p>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    
    <script>
        // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
        document.addEventListener('DOMContentLoaded', function() {
            const adminData = sessionStorage.getItem('adminData');
            if (adminData) {
                navigateTo('dashboard.html');
            }
        });

        // ë¡œê·¸ì¸ í¼ ì œì¶œ
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const remember = document.getElementById('remember').checked;
            
            if (!username || !password) {
                showAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            showLoading('ë¡œê·¸ì¸ ì¤‘...');
            
            try {
                // 1. DBì—ì„œ ê´€ë¦¬ì ì •ë³´ ì¡°íšŒ
                const { data: admin, error } = await supabase
                    .from('admins')
                    .select('*')
                    .eq('username', username)
                    .eq('is_active', true)
                    .single();
                
                if (error || !admin) {
                    throw new Error('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                }
                
                // 2. ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (SupabaseëŠ” crypt í•¨ìˆ˜ ì‚¬ìš©)
                const { data: passwordCheck, error: pwError } = await supabase
                    .rpc('check_admin_password', {
                        admin_id: admin.id,
                        input_password: password
                    });
                
                // RPC í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ì„ì‹œë¡œ í‰ë¬¸ ë¹„êµ (ê°œë°œìš©)
                // ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™” ë¹„êµ í•„ìš”!
                let isPasswordValid = false;
                
                if (pwError) {
                    // RPC í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ì„ì‹œ ë°©ë²•
                    console.warn('ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ RPC í•¨ìˆ˜ ì—†ìŒ - ê°œë°œ ëª¨ë“œ');
                    // ê°œë°œìš©: admin1234! í—ˆìš©
                    isPasswordValid = (username === 'admin' && password === 'admin1234!');
                } else {
                    isPasswordValid = passwordCheck;
                }
                
                if (!isPasswordValid) {
                    throw new Error('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                }
                
                // 3. ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
                await supabase
                    .from('admins')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', admin.id);
                
                // 4. ì„¸ì…˜ì— ê´€ë¦¬ì ì •ë³´ ì €ì¥
                const adminData = {
                    id: admin.id,
                    username: admin.username,
                    name: admin.name,
                    role: admin.role,
                    email: admin.email
                };
                
                if (remember) {
                    localStorage.setItem('adminData', JSON.stringify(adminData));
                } else {
                    sessionStorage.setItem('adminData', JSON.stringify(adminData));
                }
                
                // 5. ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡
                await supabase
                    .from('access_logs')
                    .insert({
                        admin_id: admin.id,
                        action: 'ê´€ë¦¬ì ë¡œê·¸ì¸',
                        page: '/admin/login.html',
                        ip_address: await getClientIP(),
                        user_agent: navigator.userAgent
                    });
                
                hideLoading();
                showAlert('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                
                // 6. ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                setTimeout(() => {
                    navigateTo('dashboard.html');
                }, 500);
                
            } catch (error) {
                hideLoading();
                console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                showAlert(error.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'danger');
                
                // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€ ì´ˆê¸°í™”
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        });

        // Enter í‚¤ë¡œ ë¡œê·¸ì¸
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginForm').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>