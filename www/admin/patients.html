<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™˜ì ëª©ë¡ | ì–´ì„±ì´ˆ í•œì˜ì›</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ê´€ë¦¬ì í—¤ë” -->
    <div id="adminHeader"></div>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div id="adminNav"></div>

    <div class="container-wide">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <div style="margin-bottom: 30px;">
            <h1 style="color: #1e293b; margin-bottom: 5px;">ğŸ‘¥ í™˜ì ëª©ë¡</h1>
            <p style="color: #64748b;">ì „ì²´ í™˜ì ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card">
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: end;">
                <!-- ê²€ìƒ‰ -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="searchInput" class="form-label">ğŸ” ê²€ìƒ‰</label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="form-control" 
                        placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì ‘ìˆ˜ë²ˆí˜¸ë¡œ ê²€ìƒ‰..."
                    >
                </div>

                <!-- ìƒíƒœ í•„í„° -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="statusFilter" class="form-label">ìƒíƒœ</label>
                    <select id="statusFilter" class="form-control">
                        <option value="">ì „ì²´</option>
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="confirmed">ì§„ë£Œì™„ë£Œ</option>
                        <option value="completed">ê²°ì œì™„ë£Œ</option>
                        <option value="cancelled">ì·¨ì†Œ</option>
                    </select>
                </div>

                <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
                <button onclick="searchPatients()" class="btn btn-primary">
                    ê²€ìƒ‰
                </button>
            </div>
        </div>

        <!-- í™˜ì ëª©ë¡ í…Œì´ë¸” -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #1e293b;">
                    ì „ì²´ í™˜ì (<span id="totalCount">0</span>ëª…)
                </h3>
                <button onclick="loadPatients()" class="btn btn-secondary">
                    ğŸ”„ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>

            <div id="patientsList">
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 48px; margin-bottom: 10px;">â³</div>
                    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    <script src="../assets/js/mediAdmin.js"></script>
    
    <script>
        // Footer ì´ˆê¸°í™”
        initFooter('../');
        
        // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸...
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        if (!checkAdminAuth()) {
            // checkAdminAuthì—ì„œ ì´ë¯¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        }

        // í—¤ë”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
        document.getElementById('adminHeader').innerHTML = createAdminHeader();
        document.getElementById('adminNav').innerHTML = createAdminNav('patients');

        let allPatients = [];

        // í™˜ì ëª©ë¡ ë¡œë“œ
        async function loadPatients() {
            try {
                showLoading('í™˜ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

                const statusFilter = document.getElementById('statusFilter').value;
                const filters = {};

                if (statusFilter) {
                    filters.status = statusFilter;
                }

                allPatients = await getAllPatients(filters);
                
                hideLoading();
                renderPatients(allPatients);

            } catch (error) {
                hideLoading();
                console.error('í™˜ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'danger');
            }
        }

        // í™˜ì ê²€ìƒ‰
        async function searchPatients() {
            const keyword = document.getElementById('searchInput').value.trim();

            if (!keyword) {
                // í‚¤ì›Œë“œ ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡
                await loadPatients();
                return;
            }

            try {
                showLoading('ê²€ìƒ‰ ì¤‘...');

                // mediAdmin.jsì˜ searchPatients í•¨ìˆ˜ ì‚¬ìš©
                const results = await window.searchPatients(keyword);
                
                hideLoading();
                allPatients = results;
                renderPatients(results);

            } catch (error) {
                hideLoading();
                handleError(error, 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchPatients();
                }
            });
        });

        // í™˜ì ëª©ë¡ ë Œë”ë§
        function renderPatients(patients) {
            const container = document.getElementById('patientsList');
            document.getElementById('totalCount').textContent = patients.length;

            if (!patients || patients.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                        <p>ë“±ë¡ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ì ‘ìˆ˜ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì ‘ìˆ˜ì¼ì‹œ</th>
                            <th>ìƒíƒœ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            patients.forEach(patient => {
                html += `
                    <tr>
                        <td><strong>${patient.booking_number}</strong></td>
                        <td>${patient.users.name}</td>
                        <td>${patient.users.phone}</td>
                        <td>${formatDateTime(patient.created_at)}</td>
                        <td>${getStatusBadge(patient.status)}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="viewDetail('${patient.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;">
                                    ğŸ“„ ìƒì„¸
                                </button>
                                ${patient.status === 'pending' ? `
                                    <button onclick="createPrescriptionPage('${patient.id}')" class="btn btn-success" style="padding: 6px 12px; font-size: 14px;">
                                        ğŸ’Š ì²˜ë°©
                                    </button>
                                ` : ''}
                                ${patient.status === 'pending' ? `
                                    <button onclick="completePatient('${patient.id}')" class="btn" style="padding: 6px 12px; font-size: 14px; background: #10b981; color: white;">
                                        âœ… ì™„ë£Œ
                                    </button>
                                ` : ''}
                                <button onclick="deletePatient('${patient.id}', '${patient.booking_number}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 14px;">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // ìƒì„¸ë³´ê¸°
        function viewDetail(bookingId) {
            navigateTo(`patient-detail.html?id=${bookingId}`);
        }

        // ì²˜ë°©ì „ ë°œê¸‰ í˜ì´ì§€ë¡œ ì´ë™
        function createPrescriptionPage(bookingId) {
            navigateTo(`prescription.html?id=${bookingId}`);
        }

        // í™˜ì ì™„ë£Œ ì²˜ë¦¬
        async function completePatient(bookingId) {
            if (!confirm('ì´ í™˜ìë¥¼ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            showLoading('ì²˜ë¦¬ ì¤‘...');

            try {
                await updateBookingStatus(bookingId, 'completed');
                hideLoading();
                showAlert('ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                await loadPatients(); // ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                hideLoading();
                handleError(error, 'ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // í™˜ì ì‚­ì œ
        async function deletePatient(bookingId, bookingNumber) {
            if (!confirm(`ì ‘ìˆ˜ë²ˆí˜¸ ${bookingNumber}ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                return;
            }

            showLoading('ì‚­ì œ ì¤‘...');

            try {
                const { error } = await supabase
                    .from('bookings')
                    .delete()
                    .eq('id', bookingId);

                if (error) throw error;

                hideLoading();
                showAlert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                await loadPatients(); // ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                hideLoading();
                handleError(error, 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadPatients();
        });
    </script>
</body>
</html>