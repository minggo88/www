<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²˜ë°©ì „ ë°œí–‰ | ì–´ì„±ì´ˆ í•œì˜ì›</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ê´€ë¦¬ì í—¤ë” -->
    <div id="adminHeader"></div>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div id="adminNav"></div>

    <div class="container-wide">
        <!-- ë’¤ë¡œê°€ê¸° -->
        <div style="margin-bottom: 20px;">
            <button onclick="goBack()" class="btn btn-secondary">
                â† ë’¤ë¡œê°€ê¸°
            </button>
        </div>

        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <div style="margin-bottom: 30px;">
            <h1 style="color: #1e293b; margin-bottom: 5px;">
                ğŸ’Š ì²˜ë°©ì „ <span id="modeText">ë°œê¸‰</span>
            </h1>
            <p style="color: #64748b;">í™˜ìì˜ ì§„ë£Œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ì²˜ë°©ì „ì„ <span id="modeText2">ë°œê¸‰</span>í•˜ì„¸ìš”</p>
        </div>

        <!-- í™˜ì ì •ë³´ (ì½ê¸° ì „ìš©) -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #1e293b;">ğŸ‘¤ í™˜ì ì •ë³´</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì ‘ìˆ˜ë²ˆí˜¸</div>
                    <div style="font-weight: 600;" id="bookingNumber">-</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì´ë¦„</div>
                    <div style="font-weight: 600;" id="patientName">-</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì „í™”ë²ˆí˜¸</div>
                    <div style="font-weight: 600;" id="patientPhone">-</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì ‘ìˆ˜ì¼ì‹œ</div>
                    <div style="font-weight: 600;" id="bookingDate">-</div>
                </div>
            </div>

            <!-- ë¬¸ì§„í‘œ ë‚´ìš© -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #1e293b;">ğŸ“‹ ë¬¸ì§„í‘œ ë‚´ìš©</h4>
                    <button type="button" onclick="copyQuestionnaire()" class="btn btn-secondary">
                        ğŸ“‹ ë³µì‚¬
                    </button>
                </div>
                <div id="questionnaireData"></div>
            </div>
        </div>

        <!-- ì²˜ë°©ì „ ì‘ì„± í¼ -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #1e293b;">ğŸ“ ì²˜ë°©ì „ ì‘ì„±</h3>

            <form id="prescriptionForm">
                <input type="hidden" id="prescriptionId" name="prescriptionId">
                
                <!-- ì§„ë‹¨ëª… -->
                <div class="form-group">
                    <label for="diagnosis" class="form-label required">ì§„ë‹¨ëª…</label>
                    <input 
                        type="text" 
                        id="diagnosis" 
                        name="diagnosis" 
                        class="form-control"
                        placeholder="ì˜ˆ: ë¹„ë§Œ, ì²´ì¤‘ ê´€ë¦¬ í•„ìš”"
                        required
                    >
                    <div class="form-text">í™˜ìì˜ ìƒíƒœë¥¼ ì§„ë‹¨í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- ì²˜ë°© ë‚´ìš© -->
                <div class="form-group">
                    <label for="prescriptionDetails" class="form-label required">ì²˜ë°© ë‚´ìš©</label>
                    <textarea 
                        id="prescriptionDetails" 
                        name="prescriptionDetails" 
                        class="form-control"
                        rows="6"
                        placeholder="ì˜ˆ:&#10;1. í•´ë…í™˜ 1ì¼ 3íšŒ (ì•„ì¹¨, ì ì‹¬, ì €ë… ì‹í›„ 30ë¶„)&#10;2. ì‹ì´ìš”ë²•: ì €ì—¼ì‹, ê³ ë‹¨ë°± ìœ„ì£¼&#10;3. ìš´ë™: ì£¼ 3íšŒ ì´ìƒ ìœ ì‚°ì†Œ ìš´ë™ ê¶Œì¥&#10;4. ìˆ˜ë¶„ ì„­ì·¨ ì¶©ë¶„íˆ í•˜ê¸°"
                        required
                    ></textarea>
                    <div class="form-text">ì²˜ë°© ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš” (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)</div>
                </div>

                <!-- ì²˜ë°© ìœ í˜• -->
                <div class="form-group">
                    <label class="form-label required">ì²˜ë°© ìœ í˜•</label>
                    <div class="form-check">
                        <input type="radio" id="type_prescription" name="prescriptionType" value="prescription" class="form-check-input" required>
                        <label for="type_prescription" class="form-check-label">
                            ì²˜ë°©ì „ ë°œê¸‰ (í™˜ìê°€ ì•½êµ­ì—ì„œ ì¡°ì œ)
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="type_medicine" name="prescriptionType" value="medicine" class="form-check-input" checked>
                        <label for="type_medicine" class="form-check-label">
                            ì²˜ë°©ì•½ ì§ì ‘ ì œê³µ (í•œì˜ì›ì—ì„œ ì œê³µ)
                        </label>
                    </div>
                </div>

                <!-- ê¸ˆì•¡ -->
                <div class="form-group">
                    <label for="amount" class="form-label required">ê¸ˆì•¡ (ì›)</label>
                    <input 
                        type="number" 
                        id="amount" 
                        name="amount" 
                        class="form-control"
                        placeholder="ì˜ˆ: 50000"
                        min="0"
                        step="1000"
                        required
                    >
                    <div class="form-text">ì²˜ë°©ì „ ë°œê¸‰ ë¹„ìš© ë˜ëŠ” ì²˜ë°©ì•½ ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- íŠ¹ì´ì‚¬í•­ (ì„ íƒ) -->
                <div class="form-group">
                    <label for="notes" class="form-label">íŠ¹ì´ì‚¬í•­ (ì„ íƒ)</label>
                    <textarea 
                        id="notes" 
                        name="notes" 
                        class="form-control"
                        rows="3"
                        placeholder="ì˜ˆ: ì•Œë ˆë¥´ê¸° ì£¼ì˜, ë³µìš© ì‹œ ì£¼ì˜ì‚¬í•­ ë“±"
                    ></textarea>
                    <div class="form-text">í•„ìš”ì‹œ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" onclick="goBack()" class="btn btn-secondary btn-lg">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" style="flex: 1;" id="submitBtn">
                        ğŸ’Š ì²˜ë°©ì „ ë°œê¸‰ ë° ì•Œë¦¼ ì „ì†¡
                    </button>
                </div>
            </form>
        </div>

        <!-- ì•ˆë‚´ -->
        <div class="alert alert-info">
            <strong>ğŸ“Œ ì²˜ë°©ì „ <span id="modeText3">ë°œê¸‰</span> ì•ˆë‚´</strong><br>
            ì²˜ë°©ì „ì„ <span id="modeText4">ë°œê¸‰</span>í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì²˜ë¦¬ê°€ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤:<br>
            1. ì²˜ë°©ì „ ì •ë³´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤<br>
            2. ì ‘ìˆ˜ ìƒíƒœê°€ 'ì§„ë£Œì™„ë£Œ'ë¡œ ë³€ê²½ë©ë‹ˆë‹¤<br>
            3. í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤<br>
            4. í™˜ìëŠ” ê²°ì œ í›„ ì²˜ë°©ì „ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    <script src="../assets/js/mediAdmin.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        if (!checkAdminAuth()) {
            // checkAdminAuthì—ì„œ ì´ë¯¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        }

        // í—¤ë”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
        document.getElementById('adminHeader').innerHTML = createAdminHeader();
        document.getElementById('adminNav').innerHTML = createAdminNav('patients');

        // URLì—ì„œ booking IDì™€ prescription ID ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('id');
        const prescriptionId = urlParams.get('prescription_id');
        const isEditMode = !!prescriptionId;

        if (!bookingId) {
            showAlert('í™˜ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'danger');
            setTimeout(() => navigateTo('patients.html'), 2000);
        }

        // ìˆ˜ì • ëª¨ë“œë©´ UI ë³€ê²½
        if (isEditMode) {
            document.getElementById('modeText').textContent = 'ìˆ˜ì •';
            document.getElementById('modeText2').textContent = 'ìˆ˜ì •';
            document.getElementById('modeText3').textContent = 'ìˆ˜ì •';
            document.getElementById('modeText4').textContent = 'ìˆ˜ì •';
            document.getElementById('submitBtn').innerHTML = 'ğŸ’Š ì²˜ë°©ì „ ìˆ˜ì • ë° ì•Œë¦¼ ì „ì†¡';
            document.getElementById('prescriptionId').value = prescriptionId;
        }

        let currentBooking = null;
        let questionnaireTextData = ''; // ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ë°ì´í„°

        // í™˜ì ì •ë³´ ë¡œë“œ (ë³µí˜¸í™” í¬í•¨)
        async function loadPatientInfo() {
            try {
                showLoading('í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

                currentBooking = await getPatientDetail(bookingId);

                if (!currentBooking) {
                    throw new Error('í™˜ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                // í™˜ì ì •ë³´ í‘œì‹œ
                document.getElementById('bookingNumber').textContent = currentBooking.booking_number;
                document.getElementById('patientName').textContent = currentBooking.users.name;
                document.getElementById('patientPhone').textContent = currentBooking.users.phone;
                document.getElementById('bookingDate').textContent = formatDateTime(currentBooking.created_at);

                // ë¬¸ì§„í‘œ ë°ì´í„° í‘œì‹œ
                displayQuestionnaireData(currentBooking.questionnaire_data);

                hideLoading();

                // ìˆ˜ì • ëª¨ë“œë©´ ê¸°ì¡´ ì²˜ë°©ì „ ë°ì´í„° ë¡œë“œ
                if (isEditMode) {
                    await loadPrescriptionData();
                }

            } catch (error) {
                hideLoading();
                handleError(error, 'í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                setTimeout(() => navigateTo('patients.html'), 2000);
            }
        }

        // ê¸°ì¡´ ì²˜ë°©ì „ ë°ì´í„° ë¡œë“œ (ìˆ˜ì • ëª¨ë“œ)
        async function loadPrescriptionData() {
            try {
                showLoading('ì²˜ë°©ì „ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                const prescription = await getPrescription(prescriptionId);
                
                if (!prescription) {
                    throw new Error('ì²˜ë°©ì „ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('diagnosis').value = prescription.diagnosis || '';
                document.getElementById('prescriptionDetails').value = prescription.prescription_details || '';
                document.getElementById('amount').value = prescription.amount || '';
                document.getElementById('notes').value = prescription.notes || '';

                // ì²˜ë°© ìœ í˜• ì„ íƒ
                const typeRadio = document.querySelector(`input[name="prescriptionType"][value="${prescription.prescription_type}"]`);
                if (typeRadio) {
                    typeRadio.checked = true;
                }

                hideLoading();
            } catch (error) {
                hideLoading();
                handleError(error, 'ì²˜ë°©ì „ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ë¬¸ì§„í‘œ ë°ì´í„° í‘œì‹œ
        function displayQuestionnaireData(data) {
            const container = document.getElementById('questionnaireData');

            if (!data) {
                container.innerHTML = `
                    <div style="background: #fee2e2; padding: 20px; border-radius: 8px; border: 1px solid #ef4444;">
                        <p style="color: #991b1b; font-weight: 600;">âŒ ë¬¸ì§„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            // ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ìƒì„±
            questionnaireTextData = '=== ë¬¸ì§„í‘œ ë‚´ìš© ===\n\n';

            let html = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            `;

            // ì‹ ì¥
            if (data.height) {
                html += `
                    <div>
                        <div style="color: #64748b; font-size: 13px;">ì‹ ì¥</div>
                        <div style="font-weight: 600; margin-top: 3px;">${data.height} cm</div>
                    </div>
                `;
                questionnaireTextData += `ì‹ ì¥: ${data.height} cm\n`;
            }

            // ì²´ì¤‘
            if (data.weight) {
                html += `
                    <div>
                        <div style="color: #64748b; font-size: 13px;">ì²´ì¤‘</div>
                        <div style="font-weight: 600; margin-top: 3px;">${data.weight} kg</div>
                    </div>
                `;
                questionnaireTextData += `ì²´ì¤‘: ${data.weight} kg\n`;
            }

            // ëª©í‘œ ì²´ì¤‘
            if (data.target_weight) {
                html += `
                    <div>
                        <div style="color: #64748b; font-size: 13px;">ëª©í‘œ ì²´ì¤‘</div>
                        <div style="font-weight: 600; margin-top: 3px;">${data.target_weight} kg</div>
                    </div>
                `;
                questionnaireTextData += `ëª©í‘œ ì²´ì¤‘: ${data.target_weight} kg\n`;
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ë¬¸ì§„í‘œ ë‚´ìš© ë³µì‚¬
        function copyQuestionnaire() {
            if (!questionnaireTextData) {
                showAlert('ë³µì‚¬í•  ë¬¸ì§„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }

            navigator.clipboard.writeText(questionnaireTextData).then(() => {
                showAlert('ë¬¸ì§„í‘œ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                showAlert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'danger');
            });
        }

        // ì²˜ë°©ì „ ë°œê¸‰/ìˆ˜ì • í¼ ì œì¶œ
        document.getElementById('prescriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const diagnosis = document.getElementById('diagnosis').value.trim();
            const prescriptionDetails = document.getElementById('prescriptionDetails').value.trim();
            const prescriptionType = document.querySelector('input[name="prescriptionType"]:checked').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const notes = document.getElementById('notes').value.trim();

            if (!diagnosis || !prescriptionDetails || !amount) {
                showAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            const confirmMessage = isEditMode 
                ? 'ì²˜ë°©ì „ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìˆ˜ì • í›„ í™˜ìì—ê²Œ í…”ë ˆê·¸ë¨ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.'
                : 'ì²˜ë°©ì „ì„ ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°œê¸‰ í›„ í™˜ìì—ê²Œ í…”ë ˆê·¸ë¨ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.';

            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading(isEditMode ? 'ì²˜ë°©ì „ ìˆ˜ì • ì¤‘...' : 'ì²˜ë°©ì „ ë°œê¸‰ ì¤‘...');

            try {
                const adminData = getAdminData();

                const prescriptionData = {
                    bookingId: bookingId,
                    diagnosis: diagnosis,
                    prescriptionDetails: prescriptionDetails,
                    prescriptionType: prescriptionType,
                    amount: amount,
                    notes: notes || null,
                    adminId: adminData.id,
                    patientName: currentBooking.users.name // ì´ë¯¸ ë³µí˜¸í™”ëœ ì´ë¦„ ì‚¬ìš©
                };

                let result;
                if (isEditMode) {
                    // ìˆ˜ì • ëª¨ë“œ
                    prescriptionData.prescriptionId = prescriptionId;
                    result = await updatePrescription(prescriptionData);
                } else {
                    // ì‹ ê·œ ë°œê¸‰ ëª¨ë“œ
                    result = await createPrescription(prescriptionData);
                }

                hideLoading();
                showAlert(isEditMode ? 'ì²˜ë°©ì „ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ì²˜ë°©ì „ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                // í™˜ì ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    navigateTo(`patient-detail.html?id=${bookingId}`);
                }, 1500);

            } catch (error) {
                hideLoading();
                handleError(error, isEditMode ? 'ì²˜ë°©ì „ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤' : 'ì²˜ë°©ì „ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        });

        // ê¸ˆì•¡ ì…ë ¥ ì‹œ ìë™ í¬ë§·íŒ…
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = value;
        });

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadPatientInfo();
        });
    </script>
</body>
</html>