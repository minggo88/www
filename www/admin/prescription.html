<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²˜ë°©ì „ ë°œê¸‰ | ì–´ì„±ì´ˆ í•œì˜ì›</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ê´€ë¦¬ì í—¤ë” -->
    <div id="adminHeader"></div>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div id="adminNav"></div>

    <div class="container-wide">
        <!-- ë’¤ë¡œê°€ê¸° -->
        <div style="margin-bottom: 20px;">
            <button onclick="goBack()" class="btn btn-secondary">
                â† ë’¤ë¡œê°€ê¸°
            </button>
        </div>

        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <div style="margin-bottom: 30px;">
            <h1 style="color: #1e293b; margin-bottom: 5px;">ğŸ’Š ì²˜ë°©ì „ ë°œê¸‰</h1>
            <p style="color: #64748b;">í™˜ìì˜ ì§„ë£Œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ì²˜ë°©ì „ì„ ë°œê¸‰í•˜ì„¸ìš”</p>
        </div>

        <!-- í™˜ì ì •ë³´ (ì½ê¸° ì „ìš©) -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #1e293b;">ğŸ‘¤ í™˜ì ì •ë³´</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì ‘ìˆ˜ë²ˆí˜¸</div>
                    <div style="font-weight: 600;" id="bookingNumber">-</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì´ë¦„</div>
                    <div style="font-weight: 600;" id="patientName">-</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì „í™”ë²ˆí˜¸</div>
                    <div style="font-weight: 600;" id="patientPhone">-</div>
                </div>
                <div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">ì ‘ìˆ˜ì¼ì‹œ</div>
                    <div style="font-weight: 600;" id="bookingDate">-</div>
                </div>
            </div>

            <!-- ë¬¸ì§„í‘œ ë³´ê¸° ë²„íŠ¼ -->
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button type="button" onclick="toggleQuestionnaire()" class="btn btn-outline" id="toggleBtn">
                    ğŸ“‹ ë¬¸ì§„í‘œ ë‚´ìš© ë³´ê¸°
                </button>
                <button type="button" onclick="copyQuestionnaire()" class="btn btn-secondary" id="copyBtn" style="display: none;">
                    ğŸ“‹ ë¬¸ì§„í‘œ ë³µì‚¬
                </button>
            </div>

            <!-- ë¬¸ì§„í‘œ ë‚´ìš© (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
            <div id="questionnaireContent" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <h4 style="margin-bottom: 15px; color: #1e293b;">ë¬¸ì§„í‘œ ë‚´ìš©</h4>
                <div id="questionnaireData"></div>
            </div>
        </div>

        <!-- ì²˜ë°©ì „ ì‘ì„± í¼ -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #1e293b;">ğŸ“ ì²˜ë°©ì „ ì‘ì„±</h3>

            <form id="prescriptionForm">
                <!-- ì§„ë‹¨ëª… -->
                <div class="form-group">
                    <label for="diagnosis" class="form-label required">ì§„ë‹¨ëª…</label>
                    <input 
                        type="text" 
                        id="diagnosis" 
                        name="diagnosis" 
                        class="form-control"
                        placeholder="ì˜ˆ: ë¹„ë§Œ, ì²´ì¤‘ ê´€ë¦¬ í•„ìš”"
                        required
                    >
                    <div class="form-text">í™˜ìì˜ ìƒíƒœë¥¼ ì§„ë‹¨í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- ì²˜ë°© ë‚´ìš© -->
                <div class="form-group">
                    <label for="prescriptionDetails" class="form-label required">ì²˜ë°© ë‚´ìš©</label>
                    <textarea 
                        id="prescriptionDetails" 
                        name="prescriptionDetails" 
                        class="form-control"
                        rows="6"
                        placeholder="ì˜ˆ:&#10;1. í•´ë…í™˜ 1ì¼ 3íšŒ (ì•„ì¹¨, ì ì‹¬, ì €ë… ì‹í›„ 30ë¶„)&#10;2. ì‹ì´ìš”ë²•: ì €ì—¼ì‹, ê³ ë‹¨ë°± ìœ„ì£¼&#10;3. ìš´ë™: ì£¼ 3íšŒ ì´ìƒ ìœ ì‚°ì†Œ ìš´ë™ ê¶Œì¥&#10;4. ìˆ˜ë¶„ ì„­ì·¨ ì¶©ë¶„íˆ í•˜ê¸°"
                        required
                    ></textarea>
                    <div class="form-text">ì²˜ë°© ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš” (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)</div>
                </div>

                <!-- ì²˜ë°© ìœ í˜• -->
                <div class="form-group">
                    <label class="form-label required">ì²˜ë°© ìœ í˜•</label>
                    <div class="form-check">
                        <input type="radio" id="type_prescription" name="prescriptionType" value="prescription" class="form-check-input" required>
                        <label for="type_prescription" class="form-check-label">
                            ì²˜ë°©ì „ ë°œê¸‰ (í™˜ìê°€ ì•½êµ­ì—ì„œ ì¡°ì œ)
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="type_medicine" name="prescriptionType" value="medicine" class="form-check-input" checked>
                        <label for="type_medicine" class="form-check-label">
                            ì²˜ë°©ì•½ ì§ì ‘ ì œê³µ (í•œì˜ì›ì—ì„œ ì œê³µ)
                        </label>
                    </div>
                </div>

                <!-- ê¸ˆì•¡ -->
                <div class="form-group">
                    <label for="amount" class="form-label required">ê¸ˆì•¡ (ì›)</label>
                    <input 
                        type="number" 
                        id="amount" 
                        name="amount" 
                        class="form-control"
                        placeholder="ì˜ˆ: 50000"
                        min="0"
                        step="1000"
                        required
                    >
                    <div class="form-text">ì²˜ë°©ì „ ë°œê¸‰ ë¹„ìš© ë˜ëŠ” ì²˜ë°©ì•½ ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- íŠ¹ì´ì‚¬í•­ (ì„ íƒ) -->
                <div class="form-group">
                    <label for="notes" class="form-label">íŠ¹ì´ì‚¬í•­ (ì„ íƒ)</label>
                    <textarea 
                        id="notes" 
                        name="notes" 
                        class="form-control"
                        rows="3"
                        placeholder="ì˜ˆ: ì•Œë ˆë¥´ê¸° ì£¼ì˜, ë³µìš© ì‹œ ì£¼ì˜ì‚¬í•­ ë“±"
                    ></textarea>
                    <div class="form-text">í•„ìš”ì‹œ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" onclick="goBack()" class="btn btn-secondary btn-lg">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg" style="flex: 1;">
                        ğŸ’Š ì²˜ë°©ì „ ë°œê¸‰ ë° ì•Œë¦¼ ì „ì†¡
                    </button>
                </div>
            </form>
        </div>

        <!-- ì•ˆë‚´ -->
        <div class="alert alert-info">
            <strong>ğŸ“Œ ì²˜ë°©ì „ ë°œê¸‰ ì•ˆë‚´</strong><br>
            ì²˜ë°©ì „ì„ ë°œê¸‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì²˜ë¦¬ê°€ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤:<br>
            1. ì²˜ë°©ì „ ì •ë³´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤<br>
            2. ì ‘ìˆ˜ ìƒíƒœê°€ 'ì§„ë£Œì™„ë£Œ'ë¡œ ë³€ê²½ë©ë‹ˆë‹¤<br>
            3. í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤<br>
            4. í™˜ìëŠ” ê²°ì œ í›„ ì²˜ë°©ì „ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    <script src="../assets/js/mediAdmin.js"></script>
    
    <script>
        // Footer ì´ˆê¸°í™”
        //initFooter('../');
        
        // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸...
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        if (!checkAdminAuth()) {
            // checkAdminAuthì—ì„œ ì´ë¯¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        }

        // í—¤ë”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
        document.getElementById('adminHeader').innerHTML = createAdminHeader();
        document.getElementById('adminNav').innerHTML = createAdminNav('patients');

        // URLì—ì„œ booking ID ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('id');

        if (!bookingId) {
            showAlert('í™˜ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'danger');
            setTimeout(() => navigateTo('patients.html'), 2000);
        }

        let currentBooking = null;
        let questionnaireTextData = ''; // ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ë°ì´í„°

        // í™˜ì ì •ë³´ ë¡œë“œ
        async function loadPatientInfo() {
            try {
                showLoading('í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

                currentBooking = await getPatientDetail(bookingId);

                if (!currentBooking) {
                    throw new Error('í™˜ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                // ì´ë¯¸ ì²˜ë°©ì „ì´ ë°œê¸‰ëœ ê²½ìš°
                if (currentBooking.prescriptions && currentBooking.prescriptions.length > 0) {
                    hideLoading();
                    if (confirm('ì´ë¯¸ ì²˜ë°©ì „ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. í™˜ì ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        navigateTo(`patient-detail.html?id=${bookingId}`);
                    } else {
                        goBack();
                    }
                    return;
                }

                hideLoading();
                displayPatientInfo(currentBooking);

            } catch (error) {
                hideLoading();
                console.error('í™˜ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'danger');
                setTimeout(() => navigateTo('patients.html'), 2000);
            }
        }

        // í™˜ì ì •ë³´ í‘œì‹œ
        function displayPatientInfo(booking) {
            document.getElementById('bookingNumber').textContent = booking.booking_number;
            document.getElementById('patientName').textContent = booking.users.name;
            document.getElementById('patientPhone').textContent = booking.users.phone;
            document.getElementById('bookingDate').textContent = formatDateTime(booking.created_at);

            // ë¬¸ì§„í‘œ ë°ì´í„° í‘œì‹œ
            displayQuestionnaire(booking.notes);
        }

        // ë¬¸ì§„í‘œ í‘œì‹œ
        function displayQuestionnaire(notesString) {
            const container = document.getElementById('questionnaireData');
            
            try {
                const data = parseQuestionnaireData(notesString);

                if (!data) {
                    container.innerHTML = '<p style="color: #64748b;">ë¬¸ì§„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    questionnaireTextData = '';
                    return;
                }

                // ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                questionnaireTextData = `
[ë¬¸ì§„í‘œ ì •ë³´]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ìƒë…„ì›”ì¼: ${data.birthdate || '-'}
í‚¤: ${data.height || '-'} cm
í˜„ì¬ ì²´ì¤‘: ${data.current_weight || '-'} kg
20ëŒ€ ìµœì†Œ ì²´ì¤‘: ${data.weight_20s_min || '-'} kg
í‰ìƒ ìµœê³  ì²´ì¤‘: ${data.weight_lifetime_max || '-'} kg
ëŒ€ë³€ íšŸìˆ˜: ${data.bowel_frequency || '-'}
ëŒ€ë³€ í˜•íƒœ: ${data.bowel_type || '-'}
ì†Œí™” ìƒíƒœ: ${data.digestion || '-'}
ì»¤í”¼ì™€ ìˆ˜ë©´: ${data.coffee_sleep || '-'}
ìˆ˜ë©´ ìƒíƒœ: ${data.sleep_quality || '-'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                `.trim();

                container.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">ìƒë…„ì›”ì¼</div>
                                <div style="font-weight: 600;">${data.birthdate || '-'}</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">í‚¤</div>
                                <div style="font-weight: 600;">${data.height || '-'} cm</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">í˜„ì¬ ì²´ì¤‘</div>
                                <div style="font-weight: 600;">${data.current_weight || '-'} kg</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">20ëŒ€ ìµœì†Œ ì²´ì¤‘</div>
                                <div style="font-weight: 600;">${data.weight_20s_min || '-'} kg</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">í‰ìƒ ìµœê³  ì²´ì¤‘</div>
                                <div style="font-weight: 600;">${data.weight_lifetime_max || '-'} kg</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">ëŒ€ë³€ íšŸìˆ˜</div>
                                <div style="font-weight: 600;">${data.bowel_frequency || '-'}</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">ëŒ€ë³€ í˜•íƒœ</div>
                                <div style="font-weight: 600;">${data.bowel_type || '-'}</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">ì†Œí™” ìƒíƒœ</div>
                                <div style="font-weight: 600;">${data.digestion || '-'}</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">ì»¤í”¼ì™€ ìˆ˜ë©´</div>
                                <div style="font-weight: 600;">${data.coffee_sleep || '-'}</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                                <div style="color: #64748b; font-size: 13px;">ìˆ˜ë©´ ìƒíƒœ</div>
                                <div style="font-weight: 600;">${data.sleep_quality || '-'}</div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('ë¬¸ì§„í‘œ íŒŒì‹± ì‹¤íŒ¨:', error);
                container.innerHTML = '<p style="color: #ef4444;">ë¬¸ì§„í‘œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
                questionnaireTextData = '';
            }
        }

        // ë¬¸ì§„í‘œ ì ‘ê¸°/í¼ì¹˜ê¸°
        function toggleQuestionnaire() {
            const content = document.getElementById('questionnaireContent');
            const btn = document.getElementById('toggleBtn');
            const copyBtn = document.getElementById('copyBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'ğŸ“‹ ë¬¸ì§„í‘œ ë‚´ìš© ìˆ¨ê¸°ê¸°';
                copyBtn.style.display = 'inline-block'; // ë³µì‚¬ ë²„íŠ¼ í‘œì‹œ
            } else {
                content.style.display = 'none';
                btn.textContent = 'ğŸ“‹ ë¬¸ì§„í‘œ ë‚´ìš© ë³´ê¸°';
                copyBtn.style.display = 'none'; // ë³µì‚¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            }
        }

        // ë¬¸ì§„í‘œ ë³µì‚¬
        function copyQuestionnaire() {
            if (!questionnaireTextData) {
                showAlert('ë³µì‚¬í•  ë¬¸ì§„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }

            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard.writeText(questionnaireTextData).then(() => {
                showAlert('ë¬¸ì§„í‘œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                showAlert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'danger');
            });
        }

        // ì²˜ë°©ì „ ë°œê¸‰ í¼ ì œì¶œ
        document.getElementById('prescriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const diagnosis = document.getElementById('diagnosis').value.trim();
            const prescriptionDetails = document.getElementById('prescriptionDetails').value.trim();
            const prescriptionType = document.querySelector('input[name="prescriptionType"]:checked').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const notes = document.getElementById('notes').value.trim();

            if (!diagnosis || !prescriptionDetails || !amount) {
                showAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            if (!confirm('ì²˜ë°©ì „ì„ ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°œê¸‰ í›„ í™˜ìì—ê²Œ í…”ë ˆê·¸ë¨ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.')) {
                return;
            }

            showLoading('ì²˜ë°©ì „ ë°œê¸‰ ì¤‘...');

            try {
                const adminData = getAdminData();

                const prescriptionData = {
                    bookingId: bookingId,
                    diagnosis: diagnosis,
                    prescriptionDetails: prescriptionDetails,
                    prescriptionType: prescriptionType,
                    amount: amount,
                    notes: notes || null,
                    adminId: adminData.id,
                    patientName: currentBooking.users.name
                };

                // mediAdmin.jsì˜ createPrescription í•¨ìˆ˜ í˜¸ì¶œ
                const prescription = await createPrescription(prescriptionData);

                hideLoading();
                showAlert('ì²˜ë°©ì „ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                // í™˜ì ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    navigateTo(`patient-detail.html?id=${bookingId}`);
                }, 1500);

            } catch (error) {
                hideLoading();
                handleError(error, 'ì²˜ë°©ì „ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        });

        // ê¸ˆì•¡ ì…ë ¥ ì‹œ ìë™ í¬ë§·íŒ…
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = value;
        });

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadPatientInfo();
        });
    </script>
</body>
</html>