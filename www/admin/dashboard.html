<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ | ì–´ì„±ì´ˆ í•œì˜ì›</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- ê´€ë¦¬ì í—¤ë” -->
    <div id="adminHeader"></div>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div id="adminNav"></div>

    <div class="container-wide">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <div style="margin-bottom: 30px;">
            <h1 style="color: #1e293b; margin-bottom: 5px;">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
            <p style="color: #64748b;">ì‹¤ì‹œê°„ ì§„ë£Œ ì ‘ìˆ˜ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜ -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜</div>
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="todayCount">-</div>
                <div style="font-size: 12px; opacity: 0.8;">ê±´</div>
            </div>

            <!-- ëŒ€ê¸° ì¤‘ì¸ í™˜ì -->
            <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ëŒ€ê¸° ì¤‘ (pending)</div>
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="pendingCount">-</div>
                <div style="font-size: 12px; opacity: 0.8;">ëª…</div>
            </div>

            <!-- ì§„ë£Œ ì™„ë£Œ (confirmed) -->
            <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ì§„ë£Œ ì™„ë£Œ (confirmed)</div>
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="confirmedCount">-</div>
                <div style="font-size: 12px; opacity: 0.8;">ê±´</div>
            </div>

            <!-- ê²°ì œ ì™„ë£Œ (completed) -->
            <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ê²°ì œ ì™„ë£Œ (completed)</div>
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="completedCount">-</div>
                <div style="font-size: 12px; opacity: 0.8;">ê±´</div>
            </div>

            <!-- ì´ë²ˆ ë‹¬ ì´ ì ‘ìˆ˜ -->
            <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ì´ë²ˆ ë‹¬ ì´ ì ‘ìˆ˜</div>
                <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;" id="monthCount">-</div>
                <div style="font-size: 12px; opacity: 0.8;">ê±´</div>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜ ëª©ë¡ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #1e293b;">ğŸ”” ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- í•„í„° -->
                    <select id="statusFilter" class="form-control" style="width: auto; padding: 8px 12px;">
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="all">ì „ì²´</option>
                        <option value="confirmed">ì§„ë£Œì™„ë£Œ</option>
                        <option value="completed">ê²°ì œì™„ë£Œ</option>
                    </select>
                    <button onclick="refreshDashboard()" class="btn btn-secondary">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ì ‘ìˆ˜ ëª©ë¡ í…Œì´ë¸” -->
            <div id="todayBookingsList">
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 48px; margin-bottom: 10px;">â³</div>
                    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
            <div class="card" style="text-align: center; cursor: pointer;" onclick="navigateTo('patients.html')">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¥</div>
                <h4 style="margin-bottom: 10px; color: #1e293b;">ì „ì²´ í™˜ì ê´€ë¦¬</h4>
                <p style="color: #64748b; font-size: 14px;">ëª¨ë“  í™˜ì ëª©ë¡ í™•ì¸ ë° ê²€ìƒ‰</p>
            </div>

            <div class="card" style="text-align: center; background: #f8fafc;">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“ˆ</div>
                <h4 style="margin-bottom: 10px; color: #1e293b;">í†µê³„ ë° ë¶„ì„</h4>
                <p style="color: #64748b; font-size: 14px;">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</p>
            </div>

            <div class="card" style="text-align: center; background: #f8fafc;">
                <div style="font-size: 48px; margin-bottom: 10px;">âš™ï¸</div>
                <h4 style="margin-bottom: 10px; color: #1e293b;">ì„¤ì •</h4>
                <p style="color: #64748b; font-size: 14px;">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    <script src="../assets/js/mediAdmin.js"></script>
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        if (!checkAdminAuth()) {
            // checkAdminAuthì—ì„œ ì´ë¯¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        }

        // í—¤ë”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
        document.getElementById('adminHeader').innerHTML = createAdminHeader();
        document.getElementById('adminNav').innerHTML = createAdminNav('dashboard');

        let allTodayBookings = []; // ì „ì²´ ì˜¤ëŠ˜ ì ‘ìˆ˜ ë°ì´í„° ì €ì¥

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboard() {
            try {
                // 1. í†µê³„ ë°ì´í„° ë¡œë“œ
                const stats = await getDashboardStats();
                
                document.getElementById('todayCount').textContent = stats.todayCount;
                document.getElementById('pendingCount').textContent = stats.pendingCount;
                document.getElementById('confirmedCount').textContent = stats.confirmedCount;
                document.getElementById('completedCount').textContent = stats.completedCount;
                document.getElementById('monthCount').textContent = stats.monthCount;

                // 2. ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜ ëª©ë¡ ë¡œë“œ
                const todayBookings = await getTodayBookings();
                allTodayBookings = todayBookings; // ì „ì²´ ë°ì´í„° ì €ì¥
                
                filterBookings(); // í•„í„° ì ìš©í•˜ì—¬ ë Œë”ë§

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'danger');
            }
        }

        // í•„í„°ë§ í•¨ìˆ˜
        function filterBookings() {
            const filterValue = document.getElementById('statusFilter').value;
            
            let filteredBookings;
            
            if (filterValue === 'all') {
                filteredBookings = allTodayBookings;
            } else {
                filteredBookings = allTodayBookings.filter(booking => booking.status === filterValue);
            }
            
            // ì‹œê°„ìˆœ ì •ë ¬ (ë¨¼ì € ì‹ ì²­í•œ ìˆœì„œ = ì˜¤ë˜ëœ ìˆœì„œ)
            filteredBookings.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            renderTodayBookings(filteredBookings);
        }

        // ì˜¤ëŠ˜ ì ‘ìˆ˜ ëª©ë¡ ë Œë”ë§
        function renderTodayBookings(bookings) {
            const container = document.getElementById('todayBookingsList');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                        <p>ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ì ‘ìˆ˜ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì ‘ìˆ˜ì‹œê°„</th>
                            <th>ìƒíƒœ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            bookings.forEach(booking => {
                const time = new Date(booking.created_at);
                const timeStr = `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <tr style="cursor: pointer;" onclick="viewPatientDetail('${booking.id}')" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor=''">
                        <td><strong>${booking.booking_number}</strong></td>
                        <td>${booking.users.name}</td>
                        <td>${booking.users.phone}</td>
                        <td>${timeStr}</td>
                        <td>${getStatusBadge(booking.status)}</td>
                        <td onclick="event.stopPropagation()">
                            <div style="display: flex; gap: 5px;">
                                <button onclick="viewPatientDetail('${booking.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;">
                                    ğŸ“„ ìƒì„¸
                                </button>
                                ${booking.status !== 'completed' ? `
                                    <button onclick="confirmBooking('${booking.id}')" class="btn" style="padding: 6px 12px; font-size: 14px; background: #3b82f6; color: white;">
                                        âœ… ì§„ë£Œì™„ë£Œ
                                    </button>
                                    <button onclick="completeBooking('${booking.id}')" class="btn btn-success" style="padding: 6px 12px; font-size: 14px;">
                                        ğŸ’° ê²°ì œì™„ë£Œ
                                    </button>
                                ` : ''}
                                <button onclick="deleteBooking('${booking.id}', '${booking.booking_number}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 14px;">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // í™˜ì ìƒì„¸ë³´ê¸°
        function viewPatientDetail(bookingId) {
            navigateTo(`patient-detail.html?id=${bookingId}`);
        }

        // ì§„ë£Œ ì™„ë£Œ ì²˜ë¦¬ (pending â†’ confirmed)
        async function confirmBooking(bookingId) {
            if (!confirm('ì§„ë£Œë¥¼ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìƒíƒœê°€ "ì§„ë£Œì™„ë£Œ"ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                await updateBookingStatus(bookingId, 'confirmed');
                showAlert('ì§„ë£Œì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // í†µê³„ì™€ í…Œì´ë¸”ë§Œ ìƒˆë¡œê³ ì¹¨
                await refreshData();
            } catch (error) {
                handleError(error, 'ì§„ë£Œì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ (confirmed â†’ completed)
        async function completeBooking(bookingId) {
            if (!confirm('ì§„ë£Œì™€ ê²°ì œê°€ ëª¨ë‘ ì™„ë£Œë˜ì—ˆë‚˜ìš”?\n\n"ì˜ˆ"ë¥¼ ëˆ„ë¥´ë©´ ìƒíƒœê°€ "ê²°ì œì™„ë£Œ"ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                await updateBookingStatus(bookingId, 'completed');
                showAlert('ê²°ì œì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // í†µê³„ì™€ í…Œì´ë¸”ë§Œ ìƒˆë¡œê³ ì¹¨
                await refreshData();
            } catch (error) {
                handleError(error, 'ê²°ì œì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì ‘ìˆ˜ ì‚­ì œ
        async function deleteBooking(bookingId, bookingNumber) {
            if (!confirm(`ì ‘ìˆ˜ë²ˆí˜¸ ${bookingNumber}ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                return;
            }

            try {
                // ì ‘ìˆ˜ ì‚­ì œ (CASCADEë¡œ ê´€ë ¨ ë°ì´í„° ìë™ ì‚­ì œ)
                const { error } = await supabase
                    .from('bookings')
                    .delete()
                    .eq('id', bookingId);

                if (error) throw error;

                showAlert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                
                // í†µê³„ì™€ í…Œì´ë¸”ë§Œ ìƒˆë¡œê³ ì¹¨
                await refreshData();
            } catch (error) {
                handleError(error, 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ë°ì´í„°ë§Œ ìƒˆë¡œê³ ì¹¨ (í˜ì´ì§€ ë¦¬ë¡œë“œ ì—†ì´)
        async function refreshData() {
            try {
                // 1. í†µê³„ ë°ì´í„° ë¡œë“œ
                const stats = await getDashboardStats();
                
                document.getElementById('todayCount').textContent = stats.todayCount;
                document.getElementById('pendingCount').textContent = stats.pendingCount;
                document.getElementById('completedToday').textContent = stats.completedToday;
                document.getElementById('monthCount').textContent = stats.monthCount;

                // 2. ì˜¤ëŠ˜ ì‹ ê·œ ì ‘ìˆ˜ ëª©ë¡ ë¡œë“œ
                const todayBookings = await getTodayBookings();
                allTodayBookings = todayBookings; // ì „ì²´ ë°ì´í„° ì—…ë°ì´íŠ¸
                
                filterBookings(); // í•„í„° ì ìš©í•˜ì—¬ ë Œë”ë§

            } catch (error) {
                console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
            }
        }

        // ìƒˆë¡œê³ ì¹¨
        async function refreshDashboard() {
            await refreshData();
            showAlert('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!', 'success');
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
        let autoRefreshInterval;
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(async () => {
                console.log('ìë™ ìƒˆë¡œê³ ì¹¨...');
                await refreshData();
            }, 30000); // 30ì´ˆ
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDashboard();
            startAutoRefresh();
            
            // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('statusFilter').addEventListener('change', filterBookings);
        });

        // í˜ì´ì§€ ë– ë‚  ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>