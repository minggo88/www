<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§„ë£Œ ì‹ ì²­ - ë¹„ëŒ€ë©´ ì§„ë£Œ</title>
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1>ğŸ“‹ ì§„ë£Œ ì‹ ì²­</h1>
                <p>ì§„ë£Œë¥¼ ìœ„í•œ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>
            
            <div class="card-body">
                <!-- ì¤‘ë³µ ì•ˆë‚´ ë©”ì‹œì§€ -->
                <div id="existingPatientAlert" class="alert alert-info" style="display: none;">
                    <p><strong>ì´ë¯¸ ë“±ë¡ëœ í™˜ìì…ë‹ˆë‹¤</strong></p>
                    <p id="existingPatientInfo"></p>
                    <button type="button" class="btn btn-secondary" onclick="continueAsExisting()">
                        ê¸°ì¡´ ì •ë³´ë¡œ ê³„ì†í•˜ê¸°
                    </button>
                    <button type="button" class="btn btn-ghost" onclick="resetForm()">
                        ìƒˆë¡œ ì…ë ¥í•˜ê¸°
                    </button>
                </div>

                <form id="applyForm">
                    <div class="form-group">
                        <label for="name">ì´ë¦„ *</label>
                        <input type="text" id="name" name="name" required 
                               placeholder="ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                    </div>

                    <div class="form-group">
                        <label for="phone">ì „í™”ë²ˆí˜¸ *</label>
                        <input type="tel" id="phone" name="phone" required 
                               placeholder="010-0000-0000"
                               pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}">
                        <small>í˜•ì‹: 010-0000-0000</small>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="location.href='../index.html'">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ë‹¤ìŒ ë‹¨ê³„
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    <script>
        let existingPatient = null;
        let recentBooking = null;

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ í¬ë§·íŒ…
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 3 && value.length <= 7) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
                value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
            e.target.value = value;
        });

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ ì‹œ ì¤‘ë³µ ì²´í¬
        document.getElementById('phone').addEventListener('blur', async function() {
            const phone = this.value;
            if (phone.length === 13) { // 010-0000-0000 í˜•ì‹
                await checkDuplicatePatient(phone);
            }
        });

        // ì¤‘ë³µ í™˜ì í™•ì¸
        async function checkDuplicatePatient(phone) {
            try {
                existingPatient = await checkExistingPatient(phone);
                
                if (existingPatient) {
                    // ìµœê·¼ ì ‘ìˆ˜ ë‚´ì—­ í™•ì¸
                    recentBooking = await getRecentBooking(existingPatient.id);
                    
                    let statusText = '';
                    if (recentBooking) {
                        const statusMap = {
                            'pending': 'ëŒ€ê¸° ì¤‘',
                            'confirmed': 'ì§„ë£Œ í™•ì •',
                            'completed': 'ì§„ë£Œ ì™„ë£Œ',
                            'cancelled': 'ì·¨ì†Œë¨'
                        };
                        statusText = `<br>ìµœê·¼ ì ‘ìˆ˜: ${new Date(recentBooking.created_at).toLocaleDateString()} (${statusMap[recentBooking.status]})`;
                    }
                    
                    document.getElementById('existingPatientInfo').innerHTML = 
                        `${existingPatient.name}ë‹˜ (${existingPatient.phone})${statusText}`;
                    document.getElementById('existingPatientAlert').style.display = 'block';
                    document.getElementById('name').value = existingPatient.name;
                    document.getElementById('name').readOnly = true;
                } else {
                    resetDuplicateCheck();
                }
            } catch (error) {
                console.error('ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', error);
            }
        }

        // ê¸°ì¡´ ì •ë³´ë¡œ ê³„ì†í•˜ê¸°
        function continueAsExisting() {
            if (existingPatient) {
                // ê¸°ì¡´ í™˜ì IDë¥¼ ì„¸ì…˜ì— ì €ì¥
                sessionStorage.setItem('userId', existingPatient.id);
                sessionStorage.setItem('isExistingPatient', 'true');
                sessionStorage.setItem('patientName', existingPatient.name);
                sessionStorage.setItem('patientPhone', existingPatient.phone);
                
                // ì•½ê´€ ë™ì˜ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'terms.html';
            }
        }

        // í¼ ë¦¬ì…‹
        function resetForm() {
            document.getElementById('applyForm').reset();
            resetDuplicateCheck();
        }

        // ì¤‘ë³µ ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”
        function resetDuplicateCheck() {
            existingPatient = null;
            recentBooking = null;
            document.getElementById('existingPatientAlert').style.display = 'none';
            document.getElementById('name').readOnly = false;
            sessionStorage.removeItem('isExistingPatient');
        }

        // í¼ ì œì¶œ
        document.getElementById('applyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!name || !phone) {
                showMessage('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                let userId;

                // ê¸°ì¡´ í™˜ìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìƒˆë¡œ ìƒì„±
                if (!existingPatient) {
                    const { data, error } = await supabase
                        .from('users')
                        .insert([{ name, phone }])
                        .select()
                        .single();

                    if (error) {
                        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì „í™”ë²ˆí˜¸ì¸ ê²½ìš°
                        if (error.code === '23505') {
                            await checkDuplicatePatient(phone);
                            showMessage('ì´ë¯¸ ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤. "ê¸°ì¡´ ì •ë³´ë¡œ ê³„ì†í•˜ê¸°"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
                            return;
                        }
                        throw error;
                    }

                    userId = data.id;
                } else {
                    userId = existingPatient.id;
                }

                // ì„¸ì…˜ì— ì €ì¥
                sessionStorage.setItem('userId', userId);
                sessionStorage.setItem('patientName', name);
                sessionStorage.setItem('patientPhone', phone);

                // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
                window.location.href = 'terms.html';

            } catch (error) {
                console.error('ì‹ ì²­ ì˜¤ë¥˜:', error);
                showMessage('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            sessionStorage.removeItem('userId');
            sessionStorage.removeItem('bookingId');
            sessionStorage.removeItem('isExistingPatient');
        });
    </script>
</body>
</html>