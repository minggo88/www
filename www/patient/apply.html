<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§„ë£Œ ì‹ ì²­ - ë¹„ëŒ€ë©´ ì§„ë£Œ</title>
    <link rel="stylesheet" href="../assets/css/mediStyle.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- ì§„í–‰ ë‹¨ê³„ -->
        <div class="steps">
            <div class="step active">
                <div class="step-number">1</div>
                <div class="step-label">ì •ë³´ì…ë ¥</div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-label">ì•½ê´€ë™ì˜</div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-label">ë¬¸ì§„í‘œ</div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-label">ì™„ë£Œ</div>
            </div>
        </div>

        <!-- ì •ë³´ ì…ë ¥ ì¹´ë“œ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">í™˜ì ì •ë³´ ì…ë ¥</h2>
                <p class="card-subtitle">ë¹„ëŒ€ë©´ ì§„ë£Œë¥¼ ìœ„í•œ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>
            
            <form id="applyForm">
                <!-- ì´ë¦„ ì…ë ¥ -->
                <div class="form-group">
                    <label for="name" class="form-label required">ì´ë¦„</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="form-control"
                        placeholder="í™ê¸¸ë™"
                        required
                        maxlength="10"
                    >
                    <div class="invalid-feedback">í•œê¸€ 2-10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                    <div class="form-text">ì‹¤ëª…ì„ ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                </div>

                <!-- ì „í™”ë²ˆí˜¸ ì…ë ¥ -->
                <div class="form-group">
                    <label for="phone" class="form-label required">ì „í™”ë²ˆí˜¸</label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone" 
                        class="form-control"
                        placeholder="010-0000-0000"
                        required
                        maxlength="13"
                    >
                    <div class="invalid-feedback">010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                    <div class="form-text">ì—°ë½ ê°€ëŠ¥í•œ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="d-flex gap-2 mt-4">
                    <button type="button" onclick="goBack()" class="btn btn-secondary">
                        ì´ì „
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        ë‹¤ìŒ ë‹¨ê³„
                    </button>
                </div>
            </form>
        </div>

        <!-- ì•ˆë‚´ -->
        <div class="alert alert-info">
            <strong>ê°œì¸ì •ë³´ ë³´í˜¸</strong><br>
            ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ë©°, ì§„ë£Œ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
        </div>

        <!-- í‘¸í„° -->
        <div id="footer"></div>
    </div>

    <!-- ì¤‘ë³µ ì ‘ìˆ˜ ê²½ê³  ëª¨ë‹¬ -->
    <div id="pendingBookingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">âš ï¸</div>
                <h3 style="color: #dc2626; margin: 0 0 10px 0;">ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì ‘ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤</h3>
            </div>
            
            <div id="pendingBookingInfo" style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px; line-height: 1.8; color: #92400e;">
            </div>

            <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px;">
                <p style="font-size: 14px; color: #64748b; margin-bottom: 20px;">
                    ìƒˆë¡œ ì ‘ìˆ˜í•˜ì‹œë ¤ë©´ ì´ì „ ì ‘ìˆ˜ë¥¼ ë¨¼ì € ì·¨ì†Œí•´ì•¼ í•©ë‹ˆë‹¤.<br>
                    <strong style="color: #dc2626;">ì·¨ì†Œëœ ì ‘ìˆ˜ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>
                </p>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-danger" onclick="cancelAndReapply()" style="flex: 1;">
                        ì´ì „ ì ‘ìˆ˜ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì‹ ì²­
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closePendingModal()" style="flex: 1;">
                        ëŒì•„ê°€ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/mediConfig.js"></script>
    <script src="../assets/js/mediCommon.js"></script>
    <script>
        initFooter('../');
        
        let existingPatient = null;
        let pendingBooking = null;

        // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 3) {
                e.target.value = value;
            } else if (value.length <= 7) {
                e.target.value = value.slice(0, 3) + '-' + value.slice(3);
            } else {
                e.target.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
        });

        // ì‹¤ì‹œê°„ ì…ë ¥ ê²€ì¦
        const nameInput = document.getElementById('name');
        
        nameInput.addEventListener('blur', function() {
            if (!validateName(this.value)) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });

        phoneInput.addEventListener('blur', function() {
            if (!validatePhone(this.value)) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });

        // ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ í™•ì¸ í•¨ìˆ˜
        async function checkPendingBooking() {
            console.log('=== checkPendingBooking ì‹œì‘ ===');
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            console.log('ì…ë ¥ê°’ - ì´ë¦„:', name, 'ì „í™”ë²ˆí˜¸:', phone);

            if (!name || !validateName(name) || !phone || !validatePhone(phone)) {
                console.log('âŒ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨');
                return false;
            }

            try {
                showLoading('ì ‘ìˆ˜ ë‚´ì—­ í™•ì¸ ì¤‘...');
                console.log('ğŸ“¡ DB ì¡°íšŒ ì‹œì‘...');

                // 1. pending ìƒíƒœì¸ ëª¨ë“  ì ‘ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                console.log('ğŸ“‹ ëŒ€ê¸°ì¤‘ì¸ ëª¨ë“  ì ‘ìˆ˜ ì¡°íšŒ...');
                const { data: pendingBookings, error: bookingError } = await supabase
                    .from('bookings')
                    .select('id, user_id, booking_number, created_at, status')
                    .eq('status', 'pending');

                console.log('ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ì¡°íšŒ ê²°ê³¼:', pendingBookings);

                if (bookingError) {
                    console.error('âŒ ì ‘ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', bookingError);
                    throw bookingError;
                }

                if (!pendingBookings || pendingBookings.length === 0) {
                    console.log('âœ… ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ì—†ìŒ - ì‹ ê·œ í™˜ì');
                    hideLoading();
                    existingPatient = null;
                    pendingBooking = null;
                    return true;
                }

                console.log(`ğŸ“Š ì´ ${pendingBookings.length}ê°œì˜ ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ë°œê²¬`);

                // 2. ê° ì ‘ìˆ˜ì˜ user_idë¡œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì™€ì„œ ì´ë¦„/ì „í™”ë²ˆí˜¸ ë¹„êµ
                for (const booking of pendingBookings) {
                    console.log(`\nğŸ” ì ‘ìˆ˜ë²ˆí˜¸ ${booking.booking_number} í™•ì¸ ì¤‘...`);
                    
                    const { data: user, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', booking.user_id)
                        .single();

                    if (userError || !user) {
                        console.log('âš ï¸ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', userError);
                        continue;
                    }

                    console.log('ì‚¬ìš©ì ì¡°íšŒ ì™„ë£Œ:', user.id);

                    // 3. ì•”í˜¸í™”ëœ ì´ë¦„ ë³µí˜¸í™”
                    console.log('ğŸ”“ ì´ë¦„ ë³µí˜¸í™” ì‹œë„...');
                    let decryptedName;
                    try {
                        decryptedName = await decryptData(user.name);
                        console.log('âœ… ë³µí˜¸í™” ì„±ê³µ:', decryptedName);
                    } catch (error) {
                        console.log('âš ï¸ ë³µí˜¸í™” ì‹¤íŒ¨ - í‰ë¬¸ìœ¼ë¡œ ê°„ì£¼:', user.name);
                        decryptedName = user.name;
                    }

                    // 4. ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                    if (decryptedName === name) {
                        console.log('âœ… ì´ë¦„ ì¼ì¹˜! ì „í™”ë²ˆí˜¸ í™•ì¸ ì¤‘...');
                        
                        // 5. ì „í™”ë²ˆí˜¸ë„ ë³µí˜¸í™”í•´ì„œ í™•ì¸
                        console.log('ğŸ”“ ì „í™”ë²ˆí˜¸ ë³µí˜¸í™” ì‹œë„...');
                        let decryptedPhone;
                        try {
                            decryptedPhone = await decryptData(user.phone);
                            console.log('âœ… ë³µí˜¸í™” ì„±ê³µ:', decryptedPhone);
                        } catch (error) {
                            console.log('âš ï¸ ë³µí˜¸í™” ì‹¤íŒ¨ - í‰ë¬¸ìœ¼ë¡œ ê°„ì£¼:', user.phone);
                            decryptedPhone = user.phone;
                        }

                        // 6. ì „í™”ë²ˆí˜¸ë„ ì¼ì¹˜í•˜ë©´ ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ìˆìŒ
                        if (decryptedPhone === phone) {
                            console.log('âš ï¸ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ëª¨ë‘ ì¼ì¹˜! ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ë°œê²¬');
                            
                            pendingBooking = booking;
                            existingPatient = user;

                            const bookingDate = new Date(booking.created_at).toLocaleString('ko-KR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            document.getElementById('pendingBookingInfo').innerHTML = `
                                <p style="margin: 0 0 10px 0;"><strong>í™˜ìëª…:</strong> ${decryptedName}</p>
                                <p style="margin: 0 0 10px 0;"><strong>ì „í™”ë²ˆí˜¸:</strong> ${decryptedPhone}</p>
                                <p style="margin: 0 0 10px 0;"><strong>ì ‘ìˆ˜ì¼ì‹œ:</strong> ${bookingDate}</p>
                                <p style="margin: 0;"><strong>ì ‘ìˆ˜ë²ˆí˜¸:</strong> ${booking.booking_number}</p>
                            `;
                            
                            hideLoading();
                            document.getElementById('pendingBookingModal').style.display = 'flex';
                            console.log('ğŸš« ëª¨ë‹¬ í‘œì‹œ - ì§„í–‰ ë¶ˆê°€');
                            return false;
                        } else {
                            console.log('âŒ ì „í™”ë²ˆí˜¸ ë¶ˆì¼ì¹˜, ë‹¤ìŒ ì ‘ìˆ˜ í™•ì¸...');
                        }
                    } else {
                        console.log('âŒ ì´ë¦„ ë¶ˆì¼ì¹˜, ë‹¤ìŒ ì ‘ìˆ˜ í™•ì¸...');
                    }
                }

                console.log('âœ… ì¼ì¹˜í•˜ëŠ” ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ì—†ìŒ - ì§„í–‰ ê°€ëŠ¥');
                hideLoading();
                existingPatient = null;
                pendingBooking = null;
                return true;

            } catch (error) {
                hideLoading();
                console.error('âŒ ì ‘ìˆ˜ í™•ì¸ ì˜¤ë¥˜:', error);
                return false;
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closePendingModal() {
            document.getElementById('pendingBookingModal').style.display = 'none';
            window.location.href = '../medi_index.html';
        }

        // ì´ì „ ì ‘ìˆ˜ ì·¨ì†Œí•˜ê³  ì¬ì‹ ì²­
        async function cancelAndReapply() {
            if (!pendingBooking) return;

            const confirmed = confirm(
                `ì •ë§ë¡œ ì´ì „ ì ‘ìˆ˜(${pendingBooking.booking_number})ë¥¼ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `ì·¨ì†Œëœ ì ‘ìˆ˜ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
            );

            if (!confirmed) return;

            showLoading('ì´ì „ ì ‘ìˆ˜ë¥¼ ì·¨ì†Œí•˜ëŠ” ì¤‘...');

            try {
                const { error } = await supabase
                    .from('bookings')
                    .update({ status: 'cancelled' })
                    .eq('id', pendingBooking.id);

                if (error) throw error;

                hideLoading();
                showAlert('ì´ì „ ì ‘ìˆ˜ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œ ì ‘ìˆ˜ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.', 'success');
                
                document.getElementById('pendingBookingModal').style.display = 'none';
                pendingBooking = null;

            } catch (error) {
                hideLoading();
                handleError(error, 'ì ‘ìˆ˜ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // í¼ ì œì¶œ
        document.getElementById('applyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('\nğŸš€ === í¼ ì œì¶œ ì‹œì‘ ===');
            
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            console.log('í¼ ë°ì´í„° - ì´ë¦„:', name, 'ì „í™”ë²ˆí˜¸:', phone);
            
            // ê²€ì¦
            if (!validateName(name)) {
                console.log('âŒ ì´ë¦„ ê²€ì¦ ì‹¤íŒ¨');
                showAlert('ì´ë¦„ì„ í•œê¸€ 2-10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”', 'danger');
                document.getElementById('name').focus();
                return;
            }
            
            if (!validatePhone(phone)) {
                console.log('âŒ ì „í™”ë²ˆí˜¸ ê²€ì¦ ì‹¤íŒ¨');
                showAlert('ì „í™”ë²ˆí˜¸ë¥¼ 010-0000-0000 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”', 'danger');
                document.getElementById('phone').focus();
                return;
            }

            console.log('âœ… ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼');
            console.log('â³ ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ í™•ì¸ ì‹œì‘...');

            // ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ í™•ì¸
            const canProceed = await checkPendingBooking();
            
            console.log('ğŸ” checkPendingBooking ê²°ê³¼:', canProceed);
            console.log('í˜„ì¬ existingPatient:', existingPatient);
            console.log('í˜„ì¬ pendingBooking:', pendingBooking);
            
            // ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ê°€ ìˆìœ¼ë©´ ì§„í–‰ ì¤‘ë‹¨
            if (!canProceed) {
                console.log('ğŸ›‘ ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ê°€ ìˆì–´ ì§„í–‰ ì¤‘ë‹¨');
                console.log('=== í¼ ì œì¶œ ì¢…ë£Œ (ì¤‘ë‹¨) ===\n');
                return;
            }
            
            console.log('âœ… ëŒ€ê¸°ì¤‘ì¸ ì ‘ìˆ˜ ì—†ìŒ - ë°”ë¡œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™');
            
            // canProceedê°€ trueì´ë©´ ë°”ë¡œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
            showLoading('ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...');
            
            try {
                let userId;

                // ê¸°ì¡´ í™˜ìì¸ì§€ í™•ì¸
                if (existingPatient) {
                    console.log('ê¸°ì¡´ í™˜ìë¡œ ì €ì¥');
                    userId = existingPatient.id;
                } else {
                    console.log('ì‹ ê·œ í™˜ì ë“±ë¡ ì‹œì‘');
                    
                    console.log('ğŸ”’ ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ì•”í˜¸í™” ì¤‘...');
                    const encryptedName = await encryptData(name);
                    const encryptedPhone = await encryptData(phone);
                    console.log('ì•”í˜¸í™” ì™„ë£Œ');
                    
                    // ì‹ ê·œ í™˜ì ë“±ë¡
                    const { data, error } = await supabase
                        .from('users')
                        .insert({
                            name: encryptedName,
                            phone: encryptedPhone
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    userId = data.id;
                    console.log('ì‹ ê·œ í™˜ì ë“±ë¡ ì™„ë£Œ:', userId);
                }
                
                // ì„¸ì…˜ì— í™˜ì ì •ë³´ ì €ì¥
                savePatientData({
                    userId: userId,
                    name: name,
                    phone: phone
                });
                
                console.log('ì„¸ì…˜ ì €ì¥ ì™„ë£Œ');
                
                // ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡
                await logAccess('í™˜ì ì •ë³´ ì…ë ¥ ì™„ë£Œ', '/patient/apply.html');
                
                hideLoading();
                
                console.log('âœ… ì €ì¥ ì™„ë£Œ, ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™');
                // ë°”ë¡œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™ (ë©”ì‹œì§€ ì—†ì´)
                navigateTo('terms.html');
                
            } catch (error) {
                hideLoading();
                console.error('âŒ ì €ì¥ ì˜¤ë¥˜:', error);
                handleError(error, 'ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì´ì „ ë²„íŠ¼
        function goBack() {
            window.location.href = '../medi_index.html';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            const patientData = getPatientData();
            if (patientData) {
                document.getElementById('name').value = patientData.name || '';
                document.getElementById('phone').value = patientData.phone || '';
            }
            
            logAccess('í™˜ì ì •ë³´ ì…ë ¥ í˜ì´ì§€ ë°©ë¬¸', '/patient/apply.html');
        });
    </script>
</body>
</html>